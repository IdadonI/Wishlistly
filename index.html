<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wishlistly</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        img {
            -webkit-user-drag: none;
            pointer-events: none;
        }

        .alert-avatars {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }

        .alert-avatar {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 3px solid var(--tg-sec-bg);
            object-fit: cover;
            background: #333;
        }

        .alert-avatar.friend {
            margin-left: -20px; 
        }

        .alert-badge {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-flip-enter-active, .icon-flip-leave-active {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .icon-flip-leave-to {
            transform: scale(0) rotate(-45deg);
            opacity: 0;
        }

        .icon-flip-enter-from {
            transform: scale(0) rotate(45deg);
            opacity: 0;
        }

        :root {
            --tg-bg: var(--tg-theme-bg-color, #000);
            --tg-sec-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --tg-text: var(--tg-theme-text-color, #fff);
            --tg-hint: var(--tg-theme-hint-color, #8e8e93);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --accent: #fff;
            --danger: #ff3b30;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        body {
            background: var(--tg-bg); color: var(--tg-text); margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            overflow: hidden; height: 100vh;
        }

        #app { width: 100%; height: 100%; display: flex; flex-direction: column; }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        @keyframes slideUp { 
            from { transform: translateY(100%); } 
            to { transform: translateY(0); } 
        }
        @keyframes slideDown { 
            from { transform: translateY(0); } 
            to { transform: translateY(100%); } 
        }

        .modal-content { 
            width: 100%; background: var(--tg-sec-bg);
            padding: 30px; border-radius: 35px 35px 0 0;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .modal-content.closing {
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .recent-container { margin-bottom: 25px; width: 100%; }
        .section-label { 
            font-size: 11px; color: var(--tg-hint); margin-bottom: 12px; 
            text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; 
        }

        .recent-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }

        .recent-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 10px 14px;
            border-radius: 18px; transition: 0.2s;
        }
        .recent-item:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }

        .recent-user-info { display: flex; align-items: center; gap: 12px; }
        .recent-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; }

        .recent-text { display: flex; flex-direction: column; }
        .recent-name { font-size: 15px; font-weight: 600; color: #fff; }
        .recent-username { font-size: 13px; color: var(--tg-hint); }

        .recent-remove { 
            padding: 8px; color: var(--tg-hint); opacity: 0.6; 
            display: flex; align-items: center; justify-content: center;
        }

        .btn-main.near-check {
            background-color: #34c759 !important;
            color: #fff !important;
            transform: scale(1.2) !important;
            box-shadow: 0 0 30px rgba(52, 199, 89, 0.5);
        }

        .btn-main.near-trash {
            background-color: var(--danger) !important;
            color: #fff !important;
            transform: scale(1.2) !important;
            box-shadow: 0 0 30px rgba(255, 59, 48, 0.5);
        }

        .glass-overlay { 
            position: fixed; inset: 0; z-index: 45; 
            background: rgba(0,0,0,0);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            pointer-events: none;
        }
        .is-holding .glass-overlay { 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }

        .header-profile { padding: 15px 20px; display: flex; align-items: center; gap: 12px; z-index: 100; min-height: 66px; }
        .header-avatar { 
            width: 36px; height: 36px; border-radius: 50%; object-fit: cover; 
            border: 1.5px solid var(--tg-link); transition: opacity 0.3s ease;
        }
        .header-avatar.skeleton { border: none; background-color: var(--tg-sec-bg); }
        .header-info h1 { margin: 0; font-size: 16px; font-weight: 700; }
        .header-info p { margin: 0; font-size: 12px; color: var(--tg-hint); }

        main { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; perspective: 1200px; touch-action: none; }
        
        .wish-card {
            position: absolute; 
            width: 88vw; height: 120vw; max-width: 320px; max-height: 460px;
            border-radius: 35px; background: var(--tg-sec-bg);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.5s ease;
            transform-origin: center bottom; 
            will-change: transform, opacity;
        }

        .wish-card.is-fav-card {
            border: 2px solid var(--tg-link) !important;
            box-shadow: 0 0 20px color-mix(in srgb, var(--tg-link), transparent 60%), 0 10px 25px rgba(0,0,0,0.4);
        }

        .card-inner { width: 100%; height: 100%; border-radius: 34px; overflow: hidden; position: relative; }
        .card-inner img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-label {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 25px 25px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        .card-label h2 { margin: 0; font-size: 24px; font-weight: 800; color: #fff; }

        .card-center { transform: translateX(0) translateZ(0) rotate(0deg); opacity: 1; z-index: 40; }
        .card-left { transform: translateX(-85%) translateZ(-200px) rotate(-15deg); opacity: 0.2; z-index: 20; }
        .card-right { transform: translateX(85%) translateZ(-200px) rotate(15deg); opacity: 0.2; z-index: 20; }
        .card-hidden { transform: translateZ(-500px) scale(0.5); opacity: 0; pointer-events: none; }

        .skeleton {
            background-color: #1c1c1e;
            background-image: linear-gradient(90deg, #1c1c1e 25%, #2c2c2e 50%, #1c1c1e 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite linear;
        }
        .skeleton-text {
            background-color: #1c1c1e;
            background-image: linear-gradient(90deg, #1c1c1e 25%, #2c2c2e 50%, #1c1c1e 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite linear;
            border-radius: 6px;
        }
        @keyframes loading {
            0% { background-position: 150% 0; }
            100% { background-position: -50% 0; }
        }
        .skeleton-card {
            width: 88vw; height: 120vw; max-width: 320px; max-height: 460px;
            z-index: 30;
            border-radius: 35px;
            border: none;
        }
        .skeleton-btn {
            width: 55px; height: 55px; border-radius: 50%;
        }

        footer { height: 130px; display: flex; justify-content: space-around; align-items: center; padding: 0 30px 20px; z-index: 100; }

        .btn-ui {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.08); color: white;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
        }

        .btn-main { width: 75px; height: 75px; background: white; color: black; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(15px); z-index: 2000; 
            display: flex; align-items: flex-end; justify-content: center;
        }

        .input-group { margin-bottom: 20px; }
        input { 
            background: rgba(255,255,255,0.05); border: 1.5px solid transparent;
            color: white; padding: 18px; border-radius: 20px; width: 100%; font-size: 16px;
        }
        input:focus { border-color: var(--tg-link); }

        .btn-primary { 
            background: var(--tg-link); color: white; padding: 18px; border-radius: 20px; 
            border: none; font-weight: 700; width: 100%; font-size: 16px;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .alert-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 18px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            width: 100%;
            font-size: 16px;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-ui:active, .btn-primary:active, .btn-secondary:active {
            transform: scale(0.92);
        }

        [v-cloak] { display: none; }

        @media (prefers-color-scheme: light) {
            :root {
                --tg-bg: var(--tg-theme-bg-color, #ffffff);
                --tg-sec-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
                --tg-text: var(--tg-theme-text-color, #000000);
                --tg-hint: var(--tg-theme-hint-color, #707579);
                --soft-bg: color-mix(in srgb, var(--tg-theme-link-color, #0088cc), transparent 90%);
            }
            .modal-content { background: var(--tg-bg) !important; }
            .modal-content p, .modal-content span, .section-label, .recent-name {
                color: var(--tg-text) !important;
            }
            .btn-secondary, .btn-ui:not(.btn-main) {
                background: var(--soft-bg) !important;
                color: var(--tg-theme-link-color, #0088cc) !important;
                border: none !important;
            }
            input, .modal-content div[style*="height:250px"] {
                background: var(--tg-sec-bg) !important;
                color: var(--tg-text) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --soft-bg: color-mix(in srgb, var(--tg-theme-link-color, #0088cc), transparent 85%);
            }
            .btn-secondary, .btn-ui:not(.btn-main) {
                background: var(--soft-bg) !important;
                color: var(--tg-theme-link-color, #64b5f6) !important;
                border: none !important;
            }
        }

        .modal-content div[style*="height:250px"] {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<div id="app" v-cloak :class="{'is-holding': isHolding}">
    <div class="glass-overlay"></div>
    
    <header class="header-profile">
        <div style="position: relative; width: 36px; height: 36px;">
            <transition name="fade" mode="out-in">
                <div v-if="!currentUser?.photo" key="loader" class="header-avatar skeleton" style="position: absolute; inset: 0; border: none;"></div>
                <img v-else key="photo" :src="currentUser.photo" class="header-avatar" style="position: absolute; inset: 0;">
            </transition>
        </div>
        <div class="header-info">
            <transition name="fade" mode="out-in">
                <div v-if="isLoading && wishes.length === 0" key="name-load">
                    <div class="skeleton-text" style="width: 140px; height: 14px; margin-bottom: 8px;"></div>
                    <div class="skeleton-text" style="width: 80px; height: 10px;"></div>
                </div>
                <div v-else key="name-ready">
                    <h1>{{ viewingID ? (currentUser?.name || 'Загрузка...') : 'Мои хотелки' }}</h1>
                    <p>{{ viewingID ? '@' + (currentUser?.username || '...') : 'Ваш список' }}</p>
                </div>
            </transition>
        </div>
    </header>

    <main @touchstart.prevent="handleStart" @touchmove.prevent="handleMove" @touchend.prevent="handleEnd">
        <div v-if="isLoading && wishes.length === 0" class="wish-card skeleton-card skeleton"></div>

        <template v-else>
            <div v-for="(item, index) in displayItems" :key="item.id"
                class="wish-card" 
                :class="[getCardClass(index), {'is-fav-card': item.isFavorite}]"
                :style="getDraggingStyle(index)">
                <div class="card-inner" v-if="item.isVisible">
                    <img :src="item.image" loading="lazy">
                    <div class="card-label">
                        <h2>{{ item.title }}</h2>
                    </div>
                </div>
            </div>
            <div v-if="wishes.length === 0 && !isLoading" style="opacity:0.2; font-weight:900; font-size:14px; letter-spacing:3px;">ПУСТО</div>
        </template>
    </main>

    <footer>
        <template v-if="isLoading && wishes.length === 0">
            <div class="skeleton-btn skeleton"></div>
            <div class="btn-ui btn-main" style="background: white;"></div>
            <div class="skeleton-btn skeleton"></div>
        </template>
        <template v-else>
            <button v-if="!isHolding" @click="showFriendsModal = true" class="btn-ui">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </button>
            <div v-else style="width:55px;"></div>

            <div style="position:relative; display:flex; align-items:center;">
                <button class="btn-ui btn-main" 
                        :class="{
                            'near-trash': isNearBtn && !viewingID, 
                            'near-check': isNearBtn && viewingID
                        }"
                        @click="handleMainAction">
                    <svg v-if="isHolding && !viewingID" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    <svg v-else-if="isHolding && viewingID" width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <svg v-else-if="viewingID" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    <svg v-else width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>

            <button v-if="!isHolding" @click="toggleFavorite" class="btn-ui" 
                    :style="[wishes[currentIdx]?.isFavorite ? {color: '#ff9500'} : {}, (wishes.length === 0) ? {opacity: 0.3} : {}]"
                    :disabled="wishes.length === 0">
                <svg width="24" height="24" viewBox="0 0 24 24" :fill="wishes[currentIdx]?.isFavorite ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>
            <div v-else style="width:55px;"></div>
        </template>
    </footer>

    <transition name="fade">
        <div v-if="showFriendsModal" class="modal-overlay" @click.self="closeFriendsModal">
            <div class="modal-content" :class="{'closing': isFriendsClosing}">
                <div class="input-group">
                    <input v-model="searchUsername" type="text" placeholder="@username_друга" @keyup.enter="searchFriend()">
                </div>
                <div v-if="recentSearches.length > 0" class="recent-container">
                    <p class="section-label">Недавние поиски</p>
                    <div class="recent-list">
                        <div v-for="user in recentSearches" :key="user.uid" class="recent-item" @click="searchFriend(user.username)">
                            <div class="recent-user-info">
                                <img :src="user.photo" class="recent-avatar">
                                <div class="recent-text">
                                    <span class="recent-name">{{ user.name }}</span>
                                    <span class="recent-username">@{{ user.username }}</span>
                                </div>
                            </div>
                            <div class="recent-remove" @click.stop="removeFromHistory(user.uid)">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-primary" @click="searchFriend()">НАЙТИ ПРОФИЛЬ</button>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showAddModal" class="modal-overlay" @click.self="closeAddModal">
            <div class="modal-content" :class="{'closing': isAddClosing}">
                <div @click="$refs.f.click()" style="width:100%; height:250px; border-radius:25px; background:rgba(255,255,255,0.03); border:2px dashed rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:15px;">
                    <input type="file" ref="f" style="display:none" @change="onPhoto" accept="image/*">
                    <img v-if="newImg" :src="newImg" style="width:100%; height:100%; object-fit:cover;">
                    <span v-else style="color:var(--tg-hint)">Добавить фото</span>
                </div>
                <input v-model="newTitle" type="text" placeholder="Я хочу.." style="margin-bottom:15px;">
                <button class="btn-primary" @click="save">СОХРАНИТЬ</button>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="customAlert.show" class="modal-overlay" style="z-index: 3000;">
            <div class="modal-content" style="border-radius: 35px; text-align: center; padding: 35px 25px; width: 85%; max-width: 320px; margin: auto;">
                <div class="alert-avatars">
                    <template v-if="customAlert.senderPhoto">
                        <img :src="customAlert.senderPhoto" class="alert-avatar" style="margin-left: 0; width: 80px; height: 80px;">
                    </template>
                    <template v-else>
                        <img :src="users[myUID]?.photo" class="alert-avatar">
                        <img :src="currentUser?.photo" class="alert-avatar friend">
                    </template>
                    <div class="alert-badge">
                        <transition name="icon-flip" mode="out-in">
                            <div :key="alertIconTick" class="icon-wrapper">
                                <svg v-if="alertIconTick" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="4">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <svg v-else width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="4">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </div>
                        </transition>
                    </div>
                </div>
                <p style="font-size: 17px; font-weight: 600; margin-bottom: 25px; line-height: 1.4; color: #fff;">
                    {{ customAlert.message }}
                </p>
                <div v-if="customAlert.senderPhoto" class="alert-buttons">
                    <button class="btn-secondary" @click="customAlert.show = false; customAlert.onCancel && customAlert.onCancel(); customAlert.senderPhoto = null;">НЕТ</button>
                    <button class="btn-primary" @click="customAlert.show = false; customAlert.onConfirm && customAlert.onConfirm(); customAlert.senderPhoto = null;">ДА</button>
                </div>
                <button v-else class="btn-primary" @click="customAlert.show = false">OK</button>
            </div>
        </div>
    </transition>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const firebaseConfig = {
        apiKey: "AIzaSyDqcpROB2mIMh2rwXIAq_kAF36xhcGyiAQ",
        authDomain: "wishlist-f08b7.firebaseapp.com",
        databaseURL: "https://wishlist-f08b7-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "wishlist-f08b7",
        storageBucket: "wishlist-f08b7.firebasestorage.app",
        messagingSenderId: "748949104001",
        appId: "1:748949104001:web:5922a0dffe8b0e88893480"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = Vue.createApp({
        data() {
            return {
                myUID: tg.initDataUnsafe?.user?.id?.toString() || 'LOCAL_USER',
                myUsername: tg.initDataUnsafe?.user?.username?.toLowerCase() || '',
                viewingID: null,
                users: {}, 
                wishes: [],
                isLoading: true, 
                currentIdx: 0,
                showAddModal: false, showFriendsModal: false,
                isFriendsClosing: false, isAddClosing: false,
                newTitle: '', newImg: null, 
                searchUsername: '', 
                isHolding: false, isDragging: false, isNearBtn: false,
                startX: 0, startY: 0, moveX: 0, moveY: 0, holdTimer: null,
                recentSearches: JSON.parse(localStorage.getItem('recent_history') || '[]'),
                customAlert: { show: false, message: '', senderPhoto: null, onConfirm: null, onCancel: null },
                alertIconTick: true,
                iconInterval: null,
            }
        },
        computed: {
            displayItems() { 
                return this.wishes.map((item, index) => ({
                    ...item,
                    isVisible: Math.abs(index - this.currentIdx) <= 1
                })); 
            },
            currentUser() { return this.users[this.viewingID || this.myUID] || null; }
        },
        mounted() {
            db.ref(`users/${this.myUID}/requests`).on('child_added', (snapshot) => {
                const req = { id: snapshot.key, ...snapshot.val() };
                const sender = this.users[req.fromId];
                const senderPhoto = sender ? sender.photo : `https://ui-avatars.com/api/?name=${req.fromName}`;

                this.showNiceAlert(
                    `Пользователь ${req.fromName} выполнил вашу хотелку: "${req.wishTitle}"?`,
                    senderPhoto,
                    () => { this.handleRequest(req, true); },
                    () => { this.handleRequest(req, false); }
                );
            });

            this.initAccount();
            this.sync();
            db.ref('users').on('value', s => this.users = s.val() || {});
        },
        methods: {
            haptic(s) { try { tg.HapticFeedback.impactOccurred(s || 'medium'); } catch(e){} },
            
            toggleFavorite() {
                const item = this.wishes[this.currentIdx];
                if (!item || this.viewingID) return;
                const wasFavorite = item.isFavorite;
                this.wishes.forEach(w => {
                    if (w.isFavorite) {
                        db.ref(`users/${this.myUID}/wishes/${w.id}`).update({ isFavorite: false });
                    }
                });
                db.ref(`users/${this.myUID}/wishes/${item.id}`).update({ 
                    isFavorite: !wasFavorite 
                });
                this.haptic('success');
            },

            closeFriendsModal() {
                this.isFriendsClosing = true;
                setTimeout(() => {
                    this.showFriendsModal = false;
                    this.isFriendsClosing = false;
                }, 280);
            },

            closeAddModal() {
                this.isAddClosing = true;
                setTimeout(() => {
                    this.showAddModal = false;
                    this.isAddClosing = false;
                }, 280);
            },

            initAccount() {
                const u = tg.initDataUnsafe?.user;
                if (u) {
                    const profile = {
                        name: u.first_name,
                        username: this.myUsername,
                        photo: u.photo_url || ''
                    };
                    db.ref(`users/${this.myUID}`).update(profile);
                    if (this.myUsername) db.ref(`usernames/${this.myUsername}`).set(this.myUID);
                }
            },

            sync() {
                this.isLoading = true; 
                const id = this.viewingID || this.myUID;
                const wishesRef = db.ref(`users/${id}/wishes`);

                this.wishes = [];
                wishesRef.off();

                wishesRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        this.isLoading = false;
                    }
                });

                wishesRef.on('child_added', (snapshot) => {
                    const item = { id: snapshot.key, ...snapshot.val() };
                    this.wishes.unshift(item); 
                    this.sortWishes();
                    this.isLoading = false; 
                });

                wishesRef.on('child_changed', (snapshot) => {
                    const index = this.wishes.findIndex(w => w.id === snapshot.key);
                    if (index !== -1) {
                        this.wishes[index] = { id: snapshot.key, ...snapshot.val() };
                        this.sortWishes();
                    }
                });

                wishesRef.on('child_removed', (snapshot) => {
                    const index = this.wishes.findIndex(w => w.id === snapshot.key);
                    if (index !== -1) {
                        this.wishes.splice(index, 1);
                        if (this.currentIdx >= this.wishes.length && this.currentIdx > 0) {
                            this.currentIdx = this.wishes.length - 1;
                        }
                    }
                });
            },

            async handleRequest(req, approved) {
                const reqRef = db.ref(`users/${this.myUID}/requests/${req.id}`);
                if (approved) {
                    await db.ref(`users/${this.myUID}/wishes/${req.wishId}`).remove();
                    this.haptic('success');
                } else {
                    this.haptic('warning');
                }
                reqRef.remove();
            },

            async searchFriend(savedName = null) {
                let name = (savedName || this.searchUsername).replace('@', '').toLowerCase().trim();
                if (!name) return;

                const snap = await db.ref(`usernames/${name}`).once('value');
                if (snap.exists()) {
                    const friendUID = snap.val();
                    const friendData = this.users[friendUID];

                    if (friendUID !== this.myUID) {
                        this.addToHistory({
                            uid: friendUID,
                            username: name,
                            name: friendData?.name || name,
                            photo: friendData?.photo || ''
                        });
                    }

                    this.viewingID = friendUID;
                    this.currentIdx = 0;
                    this.sync();
                    this.closeFriendsModal(); 
                    this.searchUsername = '';
                    this.haptic('success');
                } else {
                    this.showNiceAlert("Пользователь не найден.");
                }
            },

            sortWishes() {
                this.wishes.sort((a, b) => {
                    if (a.isFavorite !== b.isFavorite) return a.isFavorite ? -1 : 1;
                    return b.id.localeCompare(a.id); 
                });
            },
            
            addToHistory(user) {
                this.recentSearches = this.recentSearches.filter(u => u.uid !== user.uid);
                this.recentSearches.unshift(user);
                if (this.recentSearches.length > 5) this.recentSearches.pop();
                localStorage.setItem('recent_history', JSON.stringify(this.recentSearches));
            },

            handleMainAction() {
                this.haptic();
                if (this.viewingID) { this.viewingID = null; this.currentIdx = 0; this.sync(); }
                else { this.showAddModal = true; }
            },

            getCardClass(index) {
                if (index === this.currentIdx) return 'card-center';
                if (index === this.currentIdx - 1) return 'card-left';
                if (index === this.currentIdx + 1) return 'card-right';
                return 'card-hidden';
            },

            getDraggingStyle(index) {   
                if (index !== this.currentIdx || !this.isDragging) return {};
                return { 
                    transform: `translate3d(${this.moveX}px, ${this.moveY}px, 100px) rotate(${this.moveX/10}deg)`,
                    transition: 'none',
                    zIndex: 1000
                };
            }, 

            handleStart(e) {
                if (!this.wishes[this.currentIdx]) return;
                const p = e.touches[0];
                this.startX = p.clientX;
                this.startY = p.clientY; 
                this.isDragging = true;
    
                this.holdTimer = setTimeout(() => {
                    this.isHolding = true; 
                    this.haptic('medium');
                }, 200);
            },

            handleMove(e) {
                if (!this.isDragging) return;
                const p = e.touches[0];
                this.moveX = p.clientX - this.startX;
                this.moveY = p.clientY - this.startY;

                if (Math.abs(this.moveX) > 15) clearTimeout(this.holdTimer);

                if (this.isHolding) {
                    const btn = document.querySelector('.btn-main');
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        const btnCenterX = rect.left + rect.width / 2;
                        const btnCenterY = rect.top + rect.height / 2;
                        const dist = Math.hypot(p.clientX - btnCenterX, p.clientY - btnCenterY);
                        this.isNearBtn = dist < 70;
                    }
                }
            },

            showNiceAlert(msg, photo = null, onConfirm = null, onCancel = null) {
                this.customAlert.message = msg;
                this.customAlert.senderPhoto = photo;
                this.customAlert.onConfirm = onConfirm;
                this.customAlert.onCancel = onCancel;
                this.customAlert.show = true;
                
                this.haptic('light');
                this.alertIconTick = true; 
                if (this.iconInterval) clearInterval(this.iconInterval);
                this.iconInterval = setInterval(() => {
                    if (this.customAlert.show) {
                        this.alertIconTick = !this.alertIconTick;
                    } else {
                        clearInterval(this.iconInterval);
                    }
                }, 1600);
            },

            handleEnd() {
                clearTimeout(this.holdTimer);
                if (!this.isDragging) return;
                const items = this.wishes;
                const item = items[this.currentIdx];

                if (this.isHolding && this.isNearBtn) {
                    if (!this.viewingID) {
                        db.ref(`users/${this.myUID}/wishes/${item.id}`).remove();
                        this.haptic('success');
                        if (this.currentIdx >= items.length - 1 && this.currentIdx > 0) this.currentIdx--;
                    } else {
                        const ownerId = this.viewingID;
                        db.ref(`users/${ownerId}/requests`).push({
                            fromId: this.myUID,
                            fromName: tg.initDataUnsafe?.user?.first_name || 'Друг',
                            wishId: item.id,
                            wishTitle: item.title,
                            timestamp: Date.now()
                        });
                        this.haptic('success');
                        this.showNiceAlert("Запрос отправлен! Владелец должен подтвердить выполнение.");
                    }
                } 
                else if (!this.isHolding) {
                    if (this.moveX > 60 && this.currentIdx > 0) {
                        this.currentIdx--;
                        this.haptic('light');
                    } else if (this.moveX < -60 && this.currentIdx < items.length - 1) {
                        this.currentIdx++;
                        this.haptic('light');
                    }
                }
                
                this.isHolding = this.isDragging = this.isNearBtn = false;
                this.moveX = this.moveY = 0;
            },

            onPhoto(e) {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const s = Math.min(800 / img.width, 800 / img.height);
                        c.width = img.width * s; c.height = img.height * s;
                        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                        this.newImg = c.toDataURL('image/jpeg', 0.8);
                    };
                };
                r.readAsDataURL(f);
            },

            removeFromHistory(uid) {
                this.haptic('light');
                this.recentSearches = this.recentSearches.filter(u => u.uid !== uid);
                localStorage.setItem('recent_history', JSON.stringify(this.recentSearches));
            },

            save() {
                if (!this.newTitle || !this.newImg) return;
                db.ref(`users/${this.myUID}/wishes`).push({ 
                    ownerId: this.myUID, 
                    title: this.newTitle, 
                    image: this.newImg 
                });
                this.closeAddModal(); 
                this.newTitle = ''; 
                this.newImg = null;
                this.currentIdx = 0;
                this.haptic('success');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
