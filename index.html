<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wishlistly</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        img {
            -webkit-user-drag: none;
            pointer-events: none;
        }

        :root {
            --tg-bg: var(--tg-theme-bg-color, #000);
            --tg-sec-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --tg-text: var(--tg-theme-text-color, #fff);
            --tg-hint: var(--tg-theme-hint-color, #8e8e93);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --accent: #fff;
            --danger: #ff3b30;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        body {
            background: var(--tg-bg); color: var(--tg-text); margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            overflow: hidden; height: 100vh;
        }

        #app { width: 100%; height: 100%; display: flex; flex-direction: column; }

        .recent-container { margin-bottom: 25px; width: 100%; }
        .section-label { 
            font-size: 11px; color: var(--tg-hint); margin-bottom: 12px; 
            text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; 
        }

        .recent-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }

        .recent-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 10px 14px;
            border-radius: 18px; transition: 0.2s;
        }
        .recent-item:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }

        .recent-user-info { display: flex; align-items: center; gap: 12px; }
        .recent-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; }

        .recent-text { display: flex; flex-direction: column; }
        .recent-name { font-size: 15px; font-weight: 600; color: #fff; }
        .recent-username { font-size: 13px; color: var(--tg-hint); }

        .recent-remove { 
            padding: 8px; color: var(--tg-hint); opacity: 0.6; 
            display: flex; align-items: center; justify-content: center;
        }

        .btn-main.near-trash {
            background-color: var(--danger) !important;
            color: #fff !important;
            transform: scale(1.1) !important;
            box-shadow: 0 0 30px rgba(255, 59, 48, 0.5);
        }

        .wish-card {
            position: absolute; 
            width: 88vw; height: 120vw; max-width: 350px; max-height: 500px;
            border-radius: 35px; background: var(--tg-sec-bg);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transform-origin: bottom center;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
            will-change: transform;
        }

        .glass-overlay { 
            position: fixed; inset: 0; z-index: 45; 
            background: rgba(0,0,0,0);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            pointer-events: none;
        }
        .is-holding .glass-overlay { 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }

        .header-profile { padding: 15px 20px; display: flex; align-items: center; gap: 12px; z-index: 100; }
        .header-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1.5px solid var(--tg-link); }
        .header-info h1 { margin: 0; font-size: 16px; font-weight: 700; }
        .header-info p { margin: 0; font-size: 12px; color: var(--tg-hint); }

        main { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; perspective: 1000px; touch-action: none; }
        
        .wish-card {
            position: absolute; width: 88vw; height: 120vw; max-width: 350px; max-height: 500px;
            border-radius: 35px; background: var(--tg-sec-bg);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
            will-change: transform;
        }
        .card-inner { width: 100%; height: 100%; border-radius: 34px; overflow: hidden; position: relative; }
        .card-inner img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-label {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 25px 25px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        .card-label h2 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }

        .card-center { transform: scale(1) translateZ(0); z-index: 40; }
        .card-next { transform: scale(0.85) translateY(15px); opacity: 0.4; z-index: 30; }
        .card-prev { transform: scale(0.85) translateY(-15px); opacity: 0; z-index: 30; }

        footer { height: 130px; display: flex; justify-content: space-around; align-items: center; padding: 0 30px 20px; z-index: 100; }

        .btn-ui {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.08); color: white;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-main { width: 75px; height: 75px; background: white; color: black; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        
        .status-btn { position: absolute; left: 50%; margin-left: -27px; background: var(--danger); transform: scale(0); opacity: 0; }
        .is-holding .status-btn { transform: translateX(-95px) scale(1); opacity: 1; }
        .is-holding .btn-main { transform: translateX(20px); }

        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(15px); z-index: 2000; 
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-content { 
            width: 100%; background: var(--tg-sec-bg);
            padding: 30px; border-radius: 35px 35px 0 0;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .input-group { margin-bottom: 20px; }
        input { 
            background: rgba(255,255,255,0.05); border: 1.5px solid transparent;
            color: white; padding: 18px; border-radius: 20px; width: 100%; font-size: 16px;
        }
        input:focus { border-color: var(--tg-link); }

        .btn-primary { 
            background: var(--tg-link); color: white; padding: 18px; border-radius: 20px; 
            border: none; font-weight: 700; width: 100%; font-size: 16px;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak :class="{'is-holding': isHolding}">
    <div class="glass-overlay"></div>
    
    <header class="header-profile" v-if="currentUser">
        <img :src="currentUser.photo" class="header-avatar">
        <div class="header-info">
            <h1>{{ viewingID ? currentUser.name : 'Мои хотелки' }}</h1>
            <p>{{ viewingID ? '@' + currentUser.username : 'Ваш список' }}</p>
        </div>
    </header>

    <main @touchstart="handleStart" @touchmove="handleMove" @touchend="handleEnd">
        <div v-for="(item, index) in displayItems" :key="item.id"
            class="wish-card" :class="getCardClass(index)"
            :style="getDraggingStyle(index)">
            <div class="card-inner">
                <img :src="item.image" loading="lazy">
                <div class="card-label">
                    <h2>{{ item.title }}</h2>
                </div>
            </div>
        </div>
        <div v-if="displayItems.length === 0" style="opacity:0.2; font-weight:900; font-size:14px; letter-spacing:3px;">ПУСТО</div>
    </main>

    <footer>
        <button v-if="!isHolding" @click="showFriendsModal = true" class="btn-ui">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        </button>
        <div v-else style="width:55px;"></div>

        <div style="position:relative; display:flex; align-items:center;">
            <button class="btn-ui btn-main" 
                    :class="{'near-trash': isNearBtn && !viewingID}"
                    @click="handleMainAction">
                <svg v-if="isHolding && !viewingID" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <svg v-else-if="viewingID" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                <svg v-else width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>

        <button v-if="!isHolding" @click="toggleArchive" class="btn-ui">
            <svg v-if="activeTab === 'wishes'" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect></svg>
            <svg v-else width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
        </button>
        <div v-else style="width:55px;"></div>
    </footer>

    <div v-if="showFriendsModal" class="modal-overlay" @click.self="showFriendsModal = false">
        <div class="modal-content">
            <div class="input-group">
                <input v-model="searchUsername" type="text" placeholder="@username_друга" @keyup.enter="searchFriend()">
            </div>
            
            <div v-if="recentSearches.length > 0" class="recent-container">
                <p class="section-label">Недавние поиски</p>
                <div class="recent-list">
                    <div v-for="user in recentSearches" :key="user.uid" class="recent-item" @click="searchFriend(user.username)">
                        <div class="recent-user-info">
                            <img :src="user.photo" class="recent-avatar">
                            <div class="recent-text">
                                <span class="recent-name">{{ user.name }}</span>
                                <span class="recent-username">@{{ user.username }}</span>
                            </div>
                        </div>
                        <div class="recent-remove" @click.stop="removeFromHistory(user.uid)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" @click="searchFriend()">НАЙТИ ПРОФИЛЬ</button>
        </div>
    </div>

    <div v-if="showAddModal" class="modal-overlay" @click.self="showAddModal = false">
        <div class="modal-content">
            <div @click="$refs.f.click()" style="width:100%; height:250px; border-radius:25px; background:rgba(255,255,255,0.03); border:2px dashed rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:15px;">
                <input type="file" ref="f" style="display:none" @change="onPhoto" accept="image/*">
                <img v-if="newImg" :src="newImg" style="width:100%; height:100%; object-fit:cover;">
                <span v-else style="color:var(--tg-hint)">Добавить фото</span>
            </div>
            <input v-model="newTitle" type="text" placeholder="Я хочу.." style="margin-bottom:15px;">
            <button class="btn-primary" @click="save">СОХРАНИТЬ</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const firebaseConfig = {
        apiKey: "AIzaSyDqcpROB2mIMh2rwXIAq_kAF36xhcGyiAQ",
        authDomain: "wishlist-f08b7.firebaseapp.com",
        databaseURL: "https://wishlist-f08b7-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "wishlist-f08b7",
        storageBucket: "wishlist-f08b7.firebasestorage.app",
        messagingSenderId: "748949104001",
        appId: "1:748949104001:web:5922a0dffe8b0e88893480"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = Vue.createApp({
        data() {
            return {
                myUID: tg.initDataUnsafe?.user?.id?.toString() || 'LOCAL_USER',
                myUsername: tg.initDataUnsafe?.user?.username?.toLowerCase() || '',
                viewingID: null,
                users: {}, wishes: [], archive: [],
                activeTab: 'wishes', currentIdx: 0,
                showAddModal: false, showFriendsModal: false,
                newTitle: '', newImg: null, 
                searchUsername: '', 
                isHolding: false, isDragging: false, isNearBtn: false,
                startX: 0, startY: 0, moveX: 0, moveY: 0, holdTimer: null,
                recentSearches: JSON.parse(localStorage.getItem('recent_history') || '[]')
            }
        },
        computed: {
            displayItems() { return this.activeTab === 'wishes' ? this.wishes : this.archive; },
            currentUser() { return this.users[this.viewingID || this.myUID]; }
        },
        mounted() {
            this.initAccount();
            this.sync();
            db.ref('users').on('value', s => this.users = s.val() || {});
        },
        methods: {
            haptic(s) { try { tg.HapticFeedback.impactOccurred(s || 'medium'); } catch(e){} },
            
            initAccount() {
                const u = tg.initDataUnsafe?.user;
                if (u) {
                    const profile = {
                        name: u.first_name,
                        username: this.myUsername,
                        photo: u.photo_url || `https://ui-avatars.com/api/?name=${u.first_name}&background=random`
                    };
                    db.ref(`users/${this.myUID}`).update(profile);
                    if (this.myUsername) db.ref(`usernames/${this.myUsername}`).set(this.myUID);
                }
            },

            sync() {
                const id = this.viewingID || this.myUID;
                db.ref(`users/${id}/wishes`).on('value', s => {
                    const d = s.val() || {};
                    this.wishes = Object.keys(d).map(k => ({id: k, ...d[k]})).reverse();
                });
                db.ref(`users/${id}/archive`).on('value', s => {
                    const d = s.val() || {};
                    this.archive = Object.keys(d).map(k => ({id: k, ...d[k]})).reverse();
                });
            },

            async searchFriend(savedName = null) {
                let name = (savedName || this.searchUsername).replace('@', '').toLowerCase().trim();
                if (!name) return;

                const snap = await db.ref(`usernames/${name}`).once('value');
                if (snap.exists()) {
                    const friendUID = snap.val();
                    const friendData = this.users[friendUID];

                    if (friendUID !== this.myUID) {
                        this.addToHistory({
                            uid: friendUID,
                            username: name,
                            name: friendData?.name || name,
                            photo: friendData?.photo || `https://ui-avatars.com/api/?name=${name}`
                        });
                    }

                    this.viewingID = friendUID;
                    this.currentIdx = 0;
                    this.sync();
                    this.showFriendsModal = false;
                    this.searchUsername = '';
                    this.haptic('success');
                } else {
                    tg.showAlert("Пользователь не найден.");
                }
            },
            
            addToHistory(user) {
                this.recentSearches = this.recentSearches.filter(u => u.uid !== user.uid);
                this.recentSearches.unshift(user);
                if (this.recentSearches.length > 5) this.recentSearches.pop();
                localStorage.setItem('recent_history', JSON.stringify(this.recentSearches));
            },

            handleMainAction() {
                this.haptic();
                if (this.viewingID) { this.viewingID = null; this.sync(); }
                else { this.showAddModal = true; }
            },

            toggleArchive() {
                this.haptic('light');
                this.activeTab = this.activeTab === 'wishes' ? 'archive' : 'wishes';
                this.currentIdx = 0;
            },

            getCardClass(index) {
                if (index === this.currentIdx) return 'card-center';
                return '';
            },

            getDraggingStyle(index) {    
            if (index < this.currentIdx) {
                return {
                    transform: 'translateY(-120%) scale(0.8) rotate(-20deg)',
                    opacity: 0,
                    zIndex: 0,
                    pointerEvents: 'none'
                };
            }

            if (index === this.currentIdx) {
                if (this.isDragging) {
                    return {
                        transform: `translate3d(${this.moveX}px, ${this.moveY}px, 0) rotate(${this.moveX / 15}deg)`,
                        transition: 'none', 
                        zIndex: 100
                    };
                }
                return { zIndex: 100, transform: 'translate3d(0,0,0) rotate(0deg)' };
            }           

            if (index > this.currentIdx) {
                const diff = index - this.currentIdx;         
                if (diff > 2) return { opacity: 0, pointerEvents: 'none' };
                const rotateStep = 4; 
                const translateYStep = 12; 
                const scaleStep = 0.04;  
                return {
                    transform: `rotate(${diff * rotateStep}deg) translateY(${diff * translateYStep}px) scale(${1 - diff * scaleStep})`,
                    opacity: 1 - diff * 0.2, 
                    zIndex: 100 - diff,     
                    pointerEvents: 'none'
                };
            }
        },  

            handleStart(e) {
                if (!this.displayItems[this.currentIdx]) return;
                this.startX = e.touches[0].clientX;
                this.startY = e.touches[0].clientY; 
                this.holdTimer = setTimeout(() => {
                    this.isHolding = true; 
                    this.isDragging = true; 
                    this.haptic('heavy');
                }, 400);
            },

            handleMove(e) {
                const p = e.touches[0];
                this.moveX = p.clientX - this.startX;
                this.moveY = p.clientY - this.startY;

                if (!this.isHolding && Math.abs(this.moveX) > 10) {
                    clearTimeout(this.holdTimer); }

                if (this.isHolding) {
                    const btn = document.querySelector('.btn-main');
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        const btnCenterX = rect.left + rect.width / 2;
                        const btnCenterY = rect.top + rect.height / 2;
                        const dist = Math.hypot(p.clientX - btnCenterX, p.clientY - btnCenterY);
                        this.isNearBtn = dist < 80;
                    }
                }
            },

            handleEnd() {
                clearTimeout(this.holdTimer);
                const items = this.displayItems;
                const item = items[this.currentIdx];
                const target = this.viewingID || this.myUID;
                if (this.isHolding && this.isNearBtn) {
                    if (!this.viewingID) {
                        this.haptic('success');
                        let nextIdx = this.currentIdx;
                        if (this.currentIdx > 0) {
                            nextIdx = this.currentIdx - 1;
                        }
                        if (this.activeTab === 'wishes') {
                            db.ref(`users/${this.myUID}/wishes/${item.id}`).remove();
                        } else {
                        db.ref(`users/${this.myUID}/archive/${item.id}`).remove();
                        }
                        this.currentIdx = nextIdx;
                    } else {
                        this.haptic('error');
                        tg.showAlert("Вы не можете удалять чужие хотелки!");
                    }
                } 
                else if (Math.abs(this.moveX) > 80 && !this.isHolding) {
                    if (this.moveX > 0 && this.currentIdx > 0) this.currentIdx--;
                    else if (this.moveX < 0 && this.currentIdx < items.length - 1) this.currentIdx++;
                }
                this.isHolding = this.isDragging = this.isNearBtn = false;
                this.moveX = this.moveY = 0;
            },

            onPhoto(e) {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const s = Math.min(800 / img.width, 800 / img.height);
                        c.width = img.width * s; c.height = img.height * s;
                        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                        this.newImg = c.toDataURL('image/jpeg', 0.8);
                    };
                };
                r.readAsDataURL(f);
            },

            removeFromHistory(uid) {
                this.haptic('light');
                this.recentSearches = this.recentSearches.filter(u => u.uid !== uid);
                localStorage.setItem('recent_history', JSON.stringify(this.recentSearches));
            },

            save() {
                if (!this.newTitle || !this.newImg) return;
                db.ref(`users/${this.myUID}/wishes`).push({ 
                    ownerId: this.myUID, 
                    title: this.newTitle, 
                    image: this.newImg 
                });
                this.showAddModal = false; 
                this.newTitle = ''; 
                this.newImg = null;
                this.currentIdx = 0;
                this.haptic('success');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
